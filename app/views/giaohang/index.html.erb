<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Giao hàng</title>
  <%= csrf_meta_tags %>
  <%= stylesheet_link_tag 'giaohang', media: 'all' %>
  <style>
    .btn-primary {
      display: inline-block;
    text-decoration: none;
    color: white;
    background-color: #4CAF50; /* Màu xanh lá nhẹ */
    padding: 12px 24px; /* Tăng kích thước padding */
    border-radius: 8px; /* Bo tròn nút thêm mềm mại */
    font-weight: 600; /* Font chữ đậm */
    font-size: 16px; /* Kích thước chữ lớn hơn */
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Hiệu ứng đổ bóng nhẹ */
    margin: 10px 0; /* Căn chỉnh khoảng cách */
    transition: background-color 0.3s ease, transform 0.2s ease; /* Hiệu ứng chuyển đổi */
    }

    .btn-primary:hover {
      background-color:rgb(58, 130, 62); /* Màu xanh lá đậm hơn khi hover */
    transform: translateY(-2px); /* Hiệu ứng nổi nhẹ khi hover */
    box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
    }
  </style>
</head>
<body>
    <h1>Danh sách đơn hàng</h1>
    <%= link_to 'Trở lại trang chủ', root_path, class: 'btn btn-primary' %>
    <!-- Form tìm kiếm -->
    
     <%= form_with(url: giaohang_index_path, method: :get, local: true) do %>
        <div class="search-container">
          <label for="search">Tìm kiếm đơn hàng:</label>
          <input type="text" name="search" id="search" placeholder="Nhập tên, số điện thoại..." value="<%= params[:search] %>">
          <label for="date">Ngày đặt:</label>
          <input type="date" name="date" id="date" value="<%= params[:date] %>">
          <button type="submit" class="btn btn-primary">Tìm kiếm</button>
        </div>
      <% end %>
   
    <table border="0" cellpadding="10">
      <thead>
        <tr>
          <th>ID</th>
          <th>Họ tên</th>
          <th>Số điện thoại</th>
          <th>Email</th>
          <th>Địa chỉ</th>
          <th>Sản phẩm</th>
          <th>Tổng thanh toán</th>
          <th>Trạng thái thanh toán</th>
          <th>Ngày đặt</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody>
        <% @donhangs.each do |donhang| %>
          <% 
            # Tách sản phẩm từ thongtinsanpham
            sanpham_details = donhang.thongtinsanpham.to_s.split(',').map(&:strip)
          %>
          <% sanpham_details.each_with_index do |sanpham, index| %>
          <tr>
            <% if index == 0 %>
              <!-- Hiển thị thông tin người đặt hàng và chi tiết sản phẩm đầu tiên -->
              <td rowspan="<%= sanpham_details.size %>"><%= donhang.id %></td>
              <td rowspan="<%= sanpham_details.size %>"><%= donhang.hoten %></td>
              <td rowspan="<%= sanpham_details.size %>"><%= donhang.sdt %></td>
              <td rowspan="<%= sanpham_details.size %>"><%= donhang.email %></td>
              <td rowspan="<%= sanpham_details.size %>"><%= donhang.diachi %></td>
            <% end %>
            <!-- Hiển thị từng sản phẩm -->
            <td><%= sanpham %></td>
            <% if index == 0 %>
              <td rowspan="<%= sanpham_details.size %>"><%= CurrencyFormatter.format_vnd(donhang.tongthanhtoan) %></td>
              <td rowspan="<%= sanpham_details.size %>"><%= donhang.trangthaithanhtoan %></td>
              <td rowspan="<%= sanpham_details.size %>"><%= donhang.ngaydathang.strftime('%d/%m/%Y') if donhang.ngaydathang.present? %></td>

              <td rowspan="<%= sanpham_details.size %>">
                  <button 
                    class="confirm-button <%= case donhang.trangthai
                                                when 'Đã xác nhận' then 'to-ship'
                                                when 'Đang vận chuyển' then 'shipping'
                                                when 'Sắp đến' then 'delivered'
                                                when 'Đã đến' then 'done'
                                                when 'Đã nhận' then 'final'
                                                when 'Đã huỷ' then 'cancel'
                                                when "Huỷ đơn hàng" then 'cancel'
                                                else ''
                                              end %>" 
                    <%= 'disabled' if donhang.trangthai == 'Đã đến' %>
                    <%= 'disabled' if donhang.trangthai == 'Đã nhận' %>
                    <%= 'disabled' if donhang.trangthai == 'Huỷ đơn hàng' %>
                    
                    data-id="<%= donhang.id %>" 
                    data-url="<%= case donhang.trangthai
                                    when 'Đã xác nhận' then vanchuyen_giaohang_path(donhang)
                                    when 'Đang vận chuyển' then sapden_giaohang_path(donhang)
                                    when 'Sắp đến' then daden_giaohang_path(donhang)
                                    when 'Đã huỷ' then cancelfinal_giaohang_path(donhang)
                                    when 'Đã đến' 
                                    else xacnhan_giaohang_path(donhang)
                                  end %>"
                  >
                    <%= case donhang.trangthai
                        when "Huỷ đơn hàng" then "Đơn hàng bị huỷ"
                        when "Đã huỷ" then "Xác nhận huỷ"
                        when "Đã nhận" then "Thành công"
                        when "Đã xác nhận" then "Vận chuyển"
                        when "Đang vận chuyển" then "Sắp đến"
                        when "Sắp đến" then "Đã đến"
                        when "Đã đến" then "Chờ nhận hàng"
                        when "Chờ nhận hàng" then "Đã nhận"
                        else "Xác nhận đơn hàng"
                        end %>
                  </button>
                </td>
            <% end %>
          </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>
     

<script>
  document.addEventListener("DOMContentLoaded", function () {
  const buttons = document.querySelectorAll(".confirm-button");

  buttons.forEach((button) => {
    button.addEventListener("click", function () {
      const orderId = this.dataset.id;
      const url = this.dataset.url;

      fetch(url, {
        method: "PATCH",
        headers: {
          "X-CSRF-Token": document.querySelector("[name='csrf-token']").content,
          "Content-Type": "application/json",
        },
      })
        .then((response) => {
          if (!response.ok) {
            return response.json().then((data) => {
              throw new Error(data.error || "Có lỗi xảy ra!");
            });
          }
          return response.json();
        })
        .then((data) => {

          if(data.trangthai === "Đã huỷ"){
            this.innerText = "Xác nhận huỷ";
            this.classList.add("cancle");  
            // Làm mới trang (reload)
            location.reload();
          }
          else if(data.trangthai === "Đã nhận"){
            this.innerText = "Thành công";
            this.classList.remove("done");
            this.classList.add("final");  
            this.disabled = true;
            // Làm mới trang (reload)
            location.reload();
          }
          else if(data.trangthai === "Đã đến"){
            this.innerText = "Đã đến";
            this.classList.remove("delivered");
            this.classList.add("done");
            // Làm mới trang (reload)
            location.reload();
          }else if(data.trangthai === "Sắp đến"){
            this.innerText = "Sắp đến";
            this.classList.remove("shipping");
            this.classList.add("delivered");
            // Làm mới trang (reload)
            location.reload();
          }else if (data.trangthai === "Đang vận chuyển") {
            this.innerText = "Đang vận chuyển";
            this.classList.remove("to-ship");
            this.classList.add("shipping");
            // Làm mới trang (reload)
            location.reload();
          } else if (data.trangthai === "Đã xác nhận") {
            this.innerText = "Vận chuyển";
            this.classList.add("to-ship");
            // Làm mới trang (reload)
            location.reload();
          }
          alert(data.message);
          // Làm mới trang (reload)
            location.reload();
        })
        .catch((error) => {
          alert(error.message);
        });
    });
  });
});

  
</script>

</body>
</html>
